# CUBE SDK

include ../../../build.mk

CEPH_CSI_DIR := /opt/k3s/ceph-csi/
CEPH_CSI_IMAGES_TGZ := ceph-csi-images.tgz

VERSION := 3.11.0
CEPH_CSI_RBD_CHART := ceph-csi-rbd-$(VERSION).tgz
CEPH_CSI_FS_CHART := ceph-csi-cephfs-$(VERSION).tgz

CEPH_CSI_IMG_TAG := v3.11.0
CEPH_CSI_IMG := quay.io/cephcsi/cephcsi
CEPH_CSI_IMG_TAR := ceph-csi.tar

CSI_PROVISIONER_IMG_TAG := v4.0.0
CSI_PROVISIONER_IMG := registry.k8s.io/sig-storage/csi-provisioner
CSI_PROVISIONER_IMG_TAR := ceph-csi-provisioner.tar

CSI_RESIZER_IMG_TAG := v1.10.0
CSI_RESIZER_IMG := registry.k8s.io/sig-storage/csi-resizer
CSI_RESIZER_IMG_TAR := ceph-csi-resizer.tar

CSI_SNAPSHOTTER_IMG_TAG := v7.0.0
CSI_SNAPSHOTTER_IMG := registry.k8s.io/sig-storage/csi-snapshotter
CSI_SNAPSHOTTER_IMG_TAR := ceph-csi-snapshotter.tar

CSI_ATTACHER_IMG_TAG := v4.5.0
CSI_ATTACHER_IMG := registry.k8s.io/sig-storage/csi-attacher
CSI_ATTACHER_IMG_TAR := ceph-csi-attacher.tar

CSI_NODE_DRIVER_REGISTER_IMG_TAG := v2.10.0
CSI_NODE_DRIVER_REGISTER_IMG := registry.k8s.io/sig-storage/csi-node-driver-registrar
CSI_NODE_DRIVER_REGISTER_IMG_TAR := ceph-csi-node-driver-registrar.tar

$(CEPH_CSI_IMG_TAR):
	$(call RUN_CMD_TIMED,docker pull $(CEPH_CSI_IMG):$(CEPH_CSI_IMG_TAG),"  PULL    $(CEPH_CSI_IMG):$(CEPH_CSI_IMG_TAG)")
	$(call RUN_CMD_TIMED,docker save $(CEPH_CSI_IMG):$(CEPH_CSI_IMG_TAG) -o $(CEPH_CSI_IMG_TAR),"  SAVE    $(CEPH_CSI_IMG_TAR)")

$(CSI_PROVISIONER_IMG_TAR):
	$(call RUN_CMD_TIMED,docker pull $(CSI_PROVISIONER_IMG):$(CSI_PROVISIONER_IMG_TAG),"  PULL    $(CSI_PROVISIONER_IMG):$(CSI_PROVISIONER_IMG_TAG)")
	$(call RUN_CMD_TIMED,docker save $(CSI_PROVISIONER_IMG):$(CSI_PROVISIONER_IMG_TAG) -o $(CSI_PROVISIONER_IMG_TAR),"  SAVE    $(CSI_PROVISIONER_IMG_TAR)")

$(CSI_RESIZER_IMG_TAR):
	$(call RUN_CMD_TIMED,docker pull $(CSI_RESIZER_IMG):$(CSI_RESIZER_IMG_TAG),"  PULL    $(CSI_RESIZER_IMG):$(CSI_RESIZER_IMG_TAG)")
	$(call RUN_CMD_TIMED,docker save $(CSI_RESIZER_IMG):$(CSI_RESIZER_IMG_TAG) -o $(CSI_RESIZER_IMG_TAR),"  SAVE    $(CSI_RESIZER_IMG_TAR)")

$(CSI_SNAPSHOTTER_IMG_TAR):
	$(call RUN_CMD_TIMED,docker pull $(CSI_SNAPSHOTTER_IMG):$(CSI_SNAPSHOTTER_IMG_TAG),"  PULL    $(CSI_SNAPSHOTTER_IMG):$(CSI_SNAPSHOTTER_IMG_TAG)")
	$(call RUN_CMD_TIMED,docker save $(CSI_SNAPSHOTTER_IMG):$(CSI_SNAPSHOTTER_IMG_TAG) -o $(CSI_SNAPSHOTTER_IMG_TAR),"  SAVE    $(CSI_SNAPSHOTTER_IMG_TAR)")

$(CSI_ATTACHER_IMG_TAR):
	$(call RUN_CMD_TIMED,docker pull $(CSI_ATTACHER_IMG):$(CSI_ATTACHER_IMG_TAG),"  PULL    $(CSI_ATTACHER_IMG):$(CSI_ATTACHER_IMG_TAG)")
	$(call RUN_CMD_TIMED,docker save $(CSI_ATTACHER_IMG):$(CSI_ATTACHER_IMG_TAG) -o $(CSI_ATTACHER_IMG_TAR),"  SAVE    $(CSI_ATTACHER_IMG_TAR)")

$(CSI_NODE_DRIVER_REGISTER_IMG_TAR):
	$(call RUN_CMD_TIMED,docker pull $(CSI_NODE_DRIVER_REGISTER_IMG):$(CSI_NODE_DRIVER_REGISTER_IMG_TAG),"  PULL    $(CSI_NODE_DRIVER_REGISTER_IMG):$(CSI_NODE_DRIVER_REGISTER_IMG_TAG)")
	$(call RUN_CMD_TIMED,docker save $(CSI_NODE_DRIVER_REGISTER_IMG):$(CSI_NODE_DRIVER_REGISTER_IMG_TAG) -o $(CSI_NODE_DRIVER_REGISTER_IMG_TAR),"  SAVE    $(CSI_NODE_DRIVER_REGISTER_IMG_TAR)")

$(CEPH_CSI_IMAGES_TGZ): $(CEPH_CSI_IMG_TAR) $(CSI_PROVISIONER_IMG_TAR) $(CSI_RESIZER_IMG_TAR) $(CSI_SNAPSHOTTER_IMG_TAR) $(CSI_ATTACHER_IMG_TAR) $(CSI_NODE_DRIVER_REGISTER_IMG_TAR)
	$(call RUN_CMD_TIMED,tar -czvf $(CEPH_CSI_IMAGES_TGZ) $(CEPH_CSI_IMG_TAR) $(CSI_PROVISIONER_IMG_TAR) $(CSI_RESIZER_IMG_TAR) $(CSI_SNAPSHOTTER_IMG_TAR) $(CSI_ATTACHER_IMG_TAR) $(CSI_NODE_DRIVER_REGISTER_IMG_TAR),"  ARC     $(CEPH_CSI_IMAGES_TGZ)")

$(CEPH_CSI_RBD_CHART):
	$(call RUN_CMD_TIMED,wget https://ceph.github.io/csi-charts/rbd/$(CEPH_CSI_RBD_CHART),"  PULL    $(CEPH_CSI_RBD_CHART)")

$(CEPH_CSI_FS_CHART):
	$(call RUN_CMD_TIMED,wget https://ceph.github.io/csi-charts/cephfs/$(CEPH_CSI_FS_CHART),"  PULL    $(CEPH_CSI_FS_CHART)")

install: $(CEPH_CSI_RBD_CHART) $(CEPH_CSI_FS_CHART) $(CEPH_CSI_IMAGES_TGZ)
	$(Q)mkdir -p $(CEPH_CSI_DIR)
	$(Q)cp -f $(CEPH_CSI_RBD_CHART) $(CEPH_CSI_FS_CHART) $(CEPH_CSI_IMAGES_TGZ) $(CEPH_CSI_DIR)

BUILD += $(CEPH_CSI_RBD_CHART) $(CEPH_CSI_FS_CHART) $(CEPH_CSI_IMAGES_TGZ)
BUILDCLEAN += $(CEPH_CSI_RBD_CHART) $(CEPH_CSI_FS_CHART) $(CEPH_CSI_IMAGES_TGZ)

include $(HEX_MAKEDIR)/hex_sdk.mk
